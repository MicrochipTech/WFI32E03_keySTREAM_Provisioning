# keySTREAM Provisioning AWS Cloud MQTT Demo <!-- omit in toc -->

<img src="images/IoT-Made-Easy-Logo.png" width=100>

> "IoT Made Easy!" - This application demonstrates the in-field provisioning and registration to a cloud-computing provider by means of the ECC608-TMNGTLS CryptoAuthentication&trade; element and Kudelski keySTREAM Trusted Agent (KTA).

Devices: **| WFI32E03 | ECC608-TMNGTLS |**<br>
Features: **| Wi-Fi |**


## ⚠ Disclaimer <!-- omit in toc -->

<p><span style="color:red"><b>
THE SOFTWARE ARE PROVIDED "AS IS" AND GIVE A PATH FOR SELF-SUPPORT AND SELF-MAINTENANCE. This repository contains example code intended to help accelerate client product development. </br>

For additional Microchip repos, see: <a href="https://github.com/Microchip-MPLAB-Harmony" target="_blank">https://github.com/Microchip-MPLAB-Harmony</a>

Checkout the <a href="https://microchipsupport.force.com/s/" target="_blank">Technical support portal</a> to access our knowledge base, community forums or submit support ticket requests.
</span></p></b>

## Contents 

- [Contents](#contents)
- [Introduction](#introduction)
- [Bill of Material](#bill-of-material)
- [Prerequisites](#prerequisites)
- [Hardware Setup](#hardware-setup)
    - [PIC32 WFI32 2.0 Curiosity Board](#pic32-wfi32-20-curiosity-board)
    - [ATECC608 TRUST Board](#atecc608-trust-board)
    - [CryptoAuth TrustMANAGER Board](#cryptoauth-trustmanager-board)
    - [MPLAB® PICkit™ 4 In-Circuit Debugger](#mplab-pickit-4-in-circuit-debugger)
- [Software Setup](#software-setup)
    - [Development Tools](#development-tools)
    - [MCC Content Library](#mcc-content-library)
    - [MQTT-Explorer](#mqtt-explorer)
    - [others](#others)
- [Firmware](#firmware)
- [Run the Demo](#run-the-demo)
- [Links](#links)


## Introduction

This application demonstrates the usage of the WFI32E03 in a Public Key Infrastructure (PKI) based environment to ensure secure communication and data protection to Amazon Web Services (AWS). This is achieved by means of Microchip's TrustMANAGER and Kudelski's keySTREAM Trusted Agent (KTA).<br><br>
<img src="images/Environment.png" style="width: 700; display: block; margin: auto; float: center"><br>
The FreeRTOS&trade; based application will host a TCP client in Wi-Fi STA mode connecting to the Home-AP. To ensure proper Wi-Fi connectivity provide the necessary details, see [here](#firmware).<br> By default, every time the IoT device is powered-up, a TCP client socket connection to Kudelski server will be established either to initially set-up, to confirm or to renew its credentials. Only if the so called in-field provisioning process has been finished successfully, the device is able to establish a secure connection to any cloud-computing provider deploying PKI e.g., Amazon Web Services.<br>
Subsequent to the provisioning step, the device generates the signer and device certificates and opens a TLS-based TCP client socket to AWS. The required public and private keys used during the protocol handshaking procedure are generated by means of information stored in the TrustMANAGER CryptoAuthentication&trade; secure element.<br>
Just prior the MQTT based demo is started, the device has to be registered once to AWS. This step is automatically taking place during the very first cloud access.<br>
In case of a successful connection to the MQTT broker has been establish, the application is subscribing to a specific MQTT-topic, followed by either creating a new or overwriting an existing default device shadow. 
After that, the application is waiting for incoming MQTT messages to change the state of the onboard LEDs. Anytime an LED state change is taking place, a reporting message will be published to the broker. To control the onboard LEDs use a proper MQTT software running on the PC, e.g. MQTT-Explorer.<br>
<b>Note:</b> It is recommended to review the following bullet points on the specific account:
>a) Kudelski<br>
- <i>My Devices</i>: double-check that the device state is set to "Onboarded"
>b) AWS 
-  <i>IoT Core &rarr; Security &rarr; Policies</i>: double-check that a device related policy has been created
-  <i>IoT Core &rarr; Security &rarr; Certificates</i>: double-check that a device related certificate ID has been created and activated
-  <i>IoT Core &rarr; All devices &rarr; Things</i>: double-check that the device has been registered


[TOP](#contents)

## Bill of Material

| TOOLS | QUANTITY |
| :- | :- |
| [PIC32 WFI32 2.0 Curiosity Board](https://www.microchip.com/en-us/development-tool/EV67T15A) | 1 |
| [ATECC608 TRUST Board Revision: 04-11017-R4 and above](https://www.microchip.com/en-us/development-tool/DT100104) | 1 |
| [CryptoAuth TrustMANAGER Board](https://www.microchip.com/en-us/development-tool/EV10E69A) | 1 |
| [MPLAB® PICkit&trade; 4 In-Circuit Debugger](https://www.microchip.com/en-us/development-tool/PG164140) | 1 |

[TOP](#contents)

## Prerequisites

- [Download](https://www.microchip.com/en-us/products/security/trust-platform/tpds) and install the latest version of Microchip Trust Platform Design Suite (TPDS)
- Create and sign in to [AWS](https://portal.aws.amazon.com/gp/aws/developer/registration/index.html?nc2=h_ct&src=header_signup) account
- Create and sign in to Kudelski IoT [keySTREAM](https://www.kudelski-iot.com/services-and-systems/microchip) account
- Before utilizing the target hardware platform the ECC608-TMNGTLS CryptoAuthentication&trade; security element (<i>TrustMANAGER</i>) needs to be registered at Kudelski IoT keySTREAM initially. Follow the instructions as described in setting up the [ATECC608 TRUST](#atecc608-trust-board) and [CryptoAuth TrustMANAGER](#cryptoauth-trustmanager-board) board. <br>Open the Microchip Trust Platform Design Suite and select <i>Usecases</i>.<br><br>
<img src="images/Tpds.png" style="width: 400; display: block; margin: auto; float: center"><br> Now select <i>"CryptoAuth Trust Platform - TMNG"</i> in the <i>Kit</i> drop-down box and <i>"keySTREAM&trade; In-field Provisioning"</i> as the <i>Usecase</i>.<br><br>
<img src="images/Usecases.png" style="width: 400; display: block; margin: auto; float: center"><br>In the next dialog execute the <i>Pre-Config instruction</i> steps one by one. At first, generate the Manifest file for the ATECC608 secure element. The second step requires device related information from Kudelski IoT keySTREAM and AWS. Finish the remaining steps 3 to 6. On success, close TPDS and open the MPLAB X project separately.<br> Now follow the instructions as described in setting up the [PIC32 WFI32 2.0 Curiosity board](#pic32-wfi32-20-curiosity-board).<br><b>Note:</b> It is recommended to watch the [tutorial video](https://www.youtube.com/watch?v=7_13wIr6eRU&t=2s) and/or to use the <i>Usecase Help</i> button and follow the guidance, e.g. to create AWS <i>things</i> and to gather necessary data.<br>
<img src="images/UsecaseHelp.png" style="width: 500; display: block; margin: auto; float: center"><br>

[TOP](#contents)

## Hardware Setup
#### <u>PIC32 WFI32 2.0 Curiosity Board</u>

  - Connect the ATECC608 TRUST and PIC32 WFI32 2.0 Curiosity board via mikroBUS&trade; header (J200)<br><br>
    <img src="images/Pic32Wfi32.png" width=300 style="display: block; margin: auto; float: center"><br>
  - For normal operations set the Power Source Selection Jumper (J202) to V<sub>BUS</sub>-VIN (5-6), if the demo software has been already programmed to the device
  - Connect the Target VBUS Micro-B Connector (J204) on the board to the computer using a micro USB cable
  - On the GPIO Header (J207), connect U1RX (PIN 13) and U1TX (PIN 23) to TX and RX pin of any USB to UART converter. When using FTDI chips, connect GND (PIN 17) additionally.
  - Home AP (Wi-Fi Access Point with internet connection)
  - For device programming, follow the instruction as described in setting up the [MPLAB® PICkit&trade; 4 In-Circuit Debugger](#mplab-pickit-4-in-circuit-debugger)

#### <u>ATECC608 TRUST Board</u>

  - To activate the <i>TrustMANAGER</i> secure element of board revision #4 set DIP switch 8 to ON (SW2)
  - To activate the <i>TrustMANAGER</i> secure element of board revision #5 or later set DIP switch 5 to ON (SW2)

#### <u>CryptoAuth TrustMANAGER Board</u>

  - Set DIP switch SW2_1 to ON to enable mikroBUS&trade; header and SW2_2 to OFF to disable the on-board devices
  - Connect the ATECC608 and CryptoAuth TrustMANAGER board via mikroBUS&trade; header
  - Connect the board to the computer using a micro USB cable

#### <u>MPLAB® PICkit&trade; 4 In-Circuit Debugger</u>

  - Set the Power Source Selection Jumper (J202) to PKOB-VIN (3-4)
  - Connect the PKOB3 Micro-B USB connector (J302) on the board to the computer using a micro USB cable
  - Connect the debugger to ISCP&trade; header (J206)
  - Connect the debugger to the computer using a micro USB cable

[TOP](#contents)

## Software Setup
#### <u>Development Tools</u>
  - MPLAB® X IDE v6.20
  - MPLAB® X IDE plug-ins: MPLAB® Code Configurator (MCC) v5.7.1 and above
  - MPLAB® XC32 C/C++ Compiler v4.10
  - MPLAB® Harmony v3
  - Device Pack: PIC32MZ-W_DFP (1.8.326)
	
#### <u>MCC Content Library</u>
|  Harmony v3 Component | version |
| :- | :- |
| bsp | v3.22.0 |
| csp | v3.19.6 |
| core | v3.13.5 |
| paho.mqtt.embedded-c | v1.2.3 |
| keySTREAM_provisioning | v1.0.1 |
| cryptoauthlib | v3.7.5 |
| wolfssl | v5.4.0 |
| wolfMQTT | v1.19.2 |
| net | v3.12.2 |
| crypto | v3.8.2 |
| wireless_wifi | v3.11.1 |
| wireless_system_pic32mzw1_wfi32e01 | v3.9.1 |
| CMSIS_5 | v5.9.0 |
| CMSIS-FreeRTOS | v11.0.1 |

#### <u>MQTT-Explorer</u>

- Create AWS IoT Security Policy:
  - AWS &rarr;  IoT Core &rarr; Security &rarr; Policies &rarr; Create policy
  - Enter a policy name, for example <i>WFI32E03_control_LEDs_Policy</i>
  - Set the minimal policy statements via the Builder or use JSON format such as:<br><br>
    ```xml
    {
      "Version": "2012-10-17",
      "Statement": [
      {
        "Effect": "Allow",
        "Action": "iot:Connect",
        "Resource": "arn:aws:iot:us-east-2:381492211849:client/${iot:Connection.Thing.ThingName}"
      },
      {
        "Effect": "Allow",
        "Action": "iot:Publish",
        "Resource": "*"
      },
      {
        "Effect": "Allow",
        "Action": "iot:Subscribe",
        "Resource": "*"
      },
      {
        "Effect": "Allow",
        "Action": "iot:Receive",
        "Resource": "*"
      },
      {
        "Effect": "Allow",
        "Action": [
          "iot:GetThingShadow",
          "iot:UpdateThingShadow"
        ],
        "Resource": "*"
      }
    ]
    }
    ```
- Create AWS IoT Thing:
  - AWS &rarr;  IoT Core &rarr; All devices &rarr; Things &rarr; Create things &rarr; Create single thing
  - Enter a thing name, for example <i>WFI32E03_control_LEDs</i> and select <i>No shadow</i> as the device shadow
  - Choose <i>Auto-generate a new certificate (recommended)</i>
  - Selected the desired policy and create the thing
  - <b>Important: One time possibility to download all certificates and keys!</b>
- Set-up MQTT-Explorer:
  - Enter a connection name and make sure the settings are the same as shown below<br><br>
<img src="images/MqttExplorer_Connect.png" style="width: 500; display: left; margin: auto;"><br>
  - Choose <i>ADVANCED</i> and add # to subscribe to all MQTT topics
  - The <i>MQTT Client ID</i> must be same as used as AWS thing name, e.g. <i>WFI32E03_control_LEDs</i><br><br>
<img src="images/MqttExplorer_Advanced.png" style="width: 500; display: left; margin: auto;"><br>
  - Choose <i>CERTIFICATES</i> and select the previously downloaded certificates and key<br><br>
<img src="images/MqttExplorer_Certificates.png" style="width: 500; display: left; margin: auto;"><br>
  - Establish a test connection to Amazon Web Services<br>

#### <u>others</u>
  - Microchip Trust Platform Design Suite (TPDS)
  - Serial Terminal application like TERA TERM

[TOP](#contents)

## Firmware

The firmware repository should be cloned/downloaded to perform the following steps:
- Check file <i>tmg_conf.c</i> of local TPDS user folder, e.g. C:\\Users\\xxx\\.trustplatform\keystream_connect\\, being already updated and containing the personal Wi-Fi settings, keySTREAM UID and the cloud endpoint is correct. If not, update manually or use TPDS and execute the <i>Pre-Config instruction</i> steps, as described in chapter [Prerequisites](#prerequisites).
- If file <i>tmg_conf.c</i> is up-to-date, copy from local TPDS user folder to the cloned/downloaded project folder and replace the existing file
- Open the local project file <i>pic32mz_w1_curiosity_freertos.X</i> in MPLAB® X IDE and <i>Set as Main Project</i>
- Clean and build the project
- Connect the Debugger as described [here](#mplab-pickit-4-in-circuit-debugger)
- Program the device either for debugging or production<br>
  
The Harmony MCC <i>Project Graph</i>'s below depicts the components utilized in this project:<br><br>
<img src="images/System_Configuration.png" style="width: 600; display: block; margin: auto; float: center">
<img src="images/Root_Configuration.png" style="width: 600; display: block; margin: auto; float: center"><br>
  <br>
<b>Note:</b> Anytime changing the settings by means of the MCC <i>Project Graph</i> press button <i>Generate</i>, located within the <i>Project Resources</i> window, to apply that changes into the code. Take special care when merging with existing code.<br>
  
[TOP](#contents)

## Run the Demo

At first, establish a connection to AWS via MQTT-Explorer. Now power-up the <i>PIC32 WFI32 2.0 Curiosity Board</i> and wait for a successful connection to AWS as well as a successful MQTT message publication. The application should print the following information to the connected terminal.<br><br>
<img src="images/TerminalOut_KeyStream.png" style="width: 500; display: left; margin: auto;"><br><br>
In case the device has been renewed or refurbished intermediate steps are printed additionally.<br><br>
<img src="images/TerminalOut_KeyStream_Refurbed.png" style="width: 350; display: left; margin: auto;"><br><br>
On successful device connection to AWS, MQTT-Explorer shows the received messages, but only previously subscribed to, related to the specific issuer. <br><br>
<img src="images/MqttExplorer_DeviceDefaultState.png" style="width: 500; display: left; margin: auto;"><br>

To control a certain LED set its <i>desired</i> state to either <b>on</b> or <b>off</b>. It is possible to modify and publish only one but also both states at the same time. Subsequently find some examples, which can be copied and entered in the editor part of the <i>Publish</i> section of MQTT-Explorer.<br>
```yaml
{"state":{"desired":{"greenLED": "on"}}}
{"state":{"desired":{"redLED": "on","greenLED": "on"}}}
{"state":{"desired":{"redLED": "off"}}}
{"state":{"desired":{"redLED": "on","greenLED": "off"}}}
```
<br>Take care, to publish messages to <i>$aws/things/<b>deviceID</b>/shadow/update</i>.<br><br>
<img src="images/MqttExplorer.png" style="width: 500; display: left; margin: auto;"><br><br>
Device' terminal printings during MQTT message exchange.<br><br>
<img src="images/TerminalOut_MQTT.png" style="width: 500; height:415; display: right; margin: auto"><br>

[TOP](#contents)

## Links

- Microchip [TrustManager](https://www.microchip.com/en-us/products/security/trust-platform/trustmanager)<br>
- download Microchip [Trusted Platform Design Suite (TPDS)](https://www.microchip.com/en-us/products/security/trust-platform/tpds)<br>
- [Amazon Web Services (AWS)](https://console.aws.amazon.com/console/home?nc2=h_ct&src=header-signin) login<br>
- Kudelski IoT [keySTREAM](https://www.kudelski-iot.com/services-and-systems/microchip) open account<br>
- Video Tutorial ["How to Set up the ECC608 TrustMANAGER with keySTREAM from Kudelski IoT"](https://www.youtube.com/watch?v=7_13wIr6eRU&t=2s)<br><br>

[TOP](#contents)
